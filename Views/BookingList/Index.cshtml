@model AspnetCoreMvcFull.ViewModels.BookingManagement.BookingListPagedViewModel
@{
  ViewData["Title"] = "Daftar Booking Crane";
  Layout = "_ContentNavbarLayout";

  // Check if viewing a specific crane's bookings
  bool showingCraneBookings = ViewBag.CraneName != null;
}

<div id="alertContainer">
  @if (!string.IsNullOrEmpty(Model.SuccessMessage))
  {
    <div class="alert alert-success alert-dismissible fade show auto-close-alert" role="alert">
      @Model.SuccessMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  @if (!string.IsNullOrEmpty(Model.ErrorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show auto-close-alert" role="alert">
      @Model.ErrorMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }
</div>

<!-- Tambahkan setelah alert container existing -->
@if (ViewBag.IsManager == true)
{
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bx bx-info-circle me-2"></i>
    <strong>Info Manager:</strong> Anda melihat booking dari departemen Anda.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}
else if (ViewBag.IsRegularUser == true)
{
  <div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="bx bx-user me-2"></i>
    <strong>Info:</strong> Anda melihat booking yang Anda buat.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}

<!-- Filter Card -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filterForm" method="get" action="@Url.Action("Index", "BookingList")">
      <div class="row g-3">
        <div class="col-md-2">
          <label class="form-label" for="CraneId">Crane</label>
          <select name="CraneId" id="CraneId" class="form-select">
            <option value="">-- Semua Crane --</option>
            @foreach (var crane in Model.Filter.CraneList)
            {
              if (Model.Filter.CraneId.ToString() == crane.Value)
              {
                <option value="@crane.Value" selected>@crane.Text</option>
              }
              else
              {
                <option value="@crane.Value">@crane.Text</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="Department">Departemen</label>
          <select name="Department" id="Department" class="form-select">
            <option value="">-- Semua Departemen --</option>
            @foreach (var dept in Model.Filter.DepartmentList)
            {
              if (Model.Filter.Department == dept.Value)
              {
                <option value="@dept.Value" selected>@dept.Text</option>
              }
              else
              {
                <option value="@dept.Value">@dept.Text</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="Status">Status</label>
          <select name="Status" id="Status" class="form-select">
            <option value="">-- Semua Status --</option>
            @foreach (var status in Model.Filter.StatusList)
            {
              if (Model.Filter.Status.ToString() == status.Value)
              {
                <option value="@status.Value" selected>@status.Text</option>
              }
              else
              {
                <option value="@status.Value">@status.Text</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="StartDate">Dari Tanggal</label>
          <input name="StartDate" id="StartDate" class="form-control" type="date"
            value="@(Model.Filter.StartDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-2">
          <label class="form-label" for="EndDate">Sampai Tanggal</label>
          <input name="EndDate" id="EndDate" class="form-control" type="date"
            value="@(Model.Filter.EndDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-2">
          <label class="form-label" for="GlobalSearch">Cari</label>
          <input name="GlobalSearch" id="GlobalSearch" class="form-control" placeholder="Ketik kata kunci..."
            value="@Model.Filter.GlobalSearch" />
        </div>
        <div class="col-12 mt-3 d-flex justify-content-between">
          <div>
            <button type="button" id="resetFilterBtn" class="btn btn-outline-secondary">
              <i class="bx bx-reset me-1"></i> Reset
            </button>
          </div>
          <div id="exportButtons" class="d-flex gap-2">
            <!-- Export buttons akan ditambahkan oleh JavaScript -->
          </div>
        </div>
      </div>

      <!-- Hidden inputs for pagination and sorting -->
      <input type="hidden" name="PageNumber" id="PageNumber" value="@Model.Filter.PageNumber" />
      <input type="hidden" name="PageSize" id="PageSize" value="@Model.Filter.PageSize" />
      <input type="hidden" name="SortBy" id="SortBy" value="@Model.Filter.SortBy" />
      <input type="hidden" name="SortDesc" id="SortDesc" value="@Model.Filter.SortDesc.ToString()" />

      <!-- Submit button for no-JS fallback -->
      <noscript>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="bx bx-filter-alt me-1"></i> Terapkan Filter
          </button>
        </div>
      </noscript>
    </form>
  </div>
</div>

<!-- Main Data Card -->
<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <!-- Title Section -->
      <div class="header-title">
        <h5 class="mb-0">
          @if (showingCraneBookings)
          {
            <!-- Full text for desktop, shortened for mobile -->
            <span class="d-none d-md-inline">Daftar Booking Crane @ViewBag.CraneName</span>
            <span class="d-md-none">Crane @ViewBag.CraneName</span>
          }
          else
          {
            <!-- Full text for desktop, shortened for mobile -->
            <span class="d-none d-md-inline">Semua Booking Crane</span>
            <span class="d-md-none">Booking Crane</span>
          }
        </h5>
      </div>

      <!-- Action Buttons -->
      <div class="header-actions d-flex gap-2">
        <a href="@Url.Action("Index", "Booking")" class="btn btn-primary btn-responsive" title="Buat Baru">
          <i class="bx bx-plus"></i>
          <span class="btn-text d-none d-sm-inline ms-1">Buat Baru</span>
        </a>
        <a href="@Url.Action("Calendar", "Booking")" class="btn btn-outline-secondary btn-responsive"
          title="Tampilan Kalender">
          <i class="bx bx-calendar"></i>
          <span class="btn-text d-none d-sm-inline ms-1">Tampilan Kalender</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Table Container - Will be updated by AJAX -->
  <div id="tableContainer">
    <!-- Loading indicator -->
    <div id="tableLoadingOverlay" class="d-none">
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Memuat data...</p>
      </div>
    </div>

    <!-- Initial content loaded from server -->
    @await Html.PartialAsync("_BookingListTable", Model)
  </div>
</div>

@section PageScripts {
  <!-- jQuery -->
  <script src="~/vendor/libs/jquery/jquery.js"></script>

  <!-- DataTables Core -->
  <script src="~/vendor/libs/datatables/js/dataTables.js"></script>

  <!-- DataTables Buttons -->
  <script src="~/vendor/libs/datatables/js/dataTables.buttons.js"></script>
  <script src="~/vendor/libs/datatables/js/buttons.dataTables.js"></script>

  <!-- Export Libraries -->
  <script src="~/vendor/libs/datatables/js/jszip.min.js"></script>
  <script src="~/vendor/libs/datatables/js/pdfmake.min.js"></script>
  <script src="~/vendor/libs/datatables/js/vfs_fonts.js"></script>

  <!-- HTML5 Export Buttons -->
  <script src="~/vendor/libs/datatables/js/buttons.html5.min.js"></script>

  <!-- Main page JavaScript -->
  <script src="~/js/booking-list.js"></script>

  <!-- Inline initialization script -->
  <script>
    $(document).ready(function () {

      var currentUser = '@(ViewBag.CurrentUser ?? "System")';

      // 1. Initialize dulu
      BookingList.init({
        // Override config di sini
        getTableUrl: '@Url.Action("GetTableData", "BookingList")',
        exportTitle: '@(ViewBag.CraneName != null ? $"Daftar Booking - Crane {ViewBag.CraneName}" : "Daftar Booking Crane")',
        companyName: 'PT. KALTIM PRIMA COAL',
        currentUser: currentUser
      });

      // 2. Set logo SETELAH init
      BookingList.setCompanyLogo('base64');
    });
  </script>
}

<!-- DataTables CSS -->
@section PageStyles {
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="~/vendor/libs/datatables/css/dataTables.dataTables.css">

  <!-- DataTables Buttons CSS -->
  <link rel="stylesheet" href="~/vendor/libs/datatables/css/buttons.dataTables.css">

  <link rel="stylesheet" href="~/css/booking-list.css">
}

<!-- Custom style for no-JS fallback -->
<style noscript>
  .js-only {
    display: none;
  }
</style>
