@model AspnetCoreMvcFull.ViewModels.MaintenanceManagement.MaintenanceHistoryPagedViewModel
@{
  ViewData["Title"] = "Riwayat Pemeliharaan Crane";
  Layout = "_ContentNavbarLayout";

  // Check if viewing a specific crane's history
  bool showingCraneHistory = ViewBag.CraneName != null;
}

<div id="alertContainer">
  @if (!string.IsNullOrEmpty(Model.SuccessMessage))
  {
    <div class="alert alert-success alert-dismissible fade show auto-close-alert" role="alert">
      @Model.SuccessMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }

  @if (!string.IsNullOrEmpty(Model.ErrorMessage))
  {
    <div class="alert alert-danger alert-dismissible fade show auto-close-alert" role="alert">
      @Model.ErrorMessage
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  }
</div>

<!-- Filter Card -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filterForm" method="get" action="@Url.Action("Index", "MaintenanceHistory")">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label" for="CraneId">Crane</label>
          <select name="CraneId" id="CraneId" class="form-select">
            <option value="">-- Semua Crane --</option>
            @foreach (var crane in Model.Filter.CraneList)
            {
              if (Model.Filter.CraneId.ToString() == crane.Value)
              {
                <option value="@crane.Value" selected>@crane.Text</option>
              }
              else
              {
                <option value="@crane.Value">@crane.Text</option>
              }
            }
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="StartDate">Dari Tanggal</label>
          <input name="StartDate" id="StartDate" class="form-control" type="date"
            value="@(Model.Filter.StartDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="EndDate">Sampai Tanggal</label>
          <input name="EndDate" id="EndDate" class="form-control" type="date"
            value="@(Model.Filter.EndDate?.ToString("yyyy-MM-dd"))" />
        </div>
        <div class="col-md-3">
          <label class="form-label" for="GlobalSearch">Cari</label>
          <input name="GlobalSearch" id="GlobalSearch" class="form-control" placeholder="Ketik kata kunci..."
            value="@Model.Filter.GlobalSearch" />
        </div>
        <div class="col-12 mt-3 d-flex justify-content-between">
          <div>
            <button type="button" id="resetFilterBtn" class="btn btn-outline-secondary">
              <i class="bx bx-reset me-1"></i> Reset
            </button>
          </div>
          <div id="exportButtons" class="d-flex gap-2">
            <!-- Tombol export akan ditambahkan oleh JavaScript -->
          </div>
        </div>
      </div>

      <!-- Hidden inputs for pagination and sorting -->
      <input type="hidden" name="PageNumber" id="PageNumber" value="@Model.Filter.PageNumber" />
      <input type="hidden" name="PageSize" id="PageSize" value="@Model.Filter.PageSize" />
      <input type="hidden" name="SortBy" id="SortBy" value="@Model.Filter.SortBy" />
      <input type="hidden" name="SortDesc" id="SortDesc" value="@Model.Filter.SortDesc.ToString()" />

      <!-- Add a submit button for no-JS fallback, hidden with CSS -->
      <noscript>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="bx bx-filter-alt me-1"></i> Terapkan Filter
          </button>
        </div>
      </noscript>
    </form>
  </div>
</div>

<!-- Main Data Card -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      @if (showingCraneHistory)
      {
        <text>Riwayat Pemeliharaan Crane @ViewBag.CraneName</text>
      }
      else
      {
        <text>Semua Jadwal Pemeliharaan</text>
      }
    </h5>
    <div>
      <a href="@Url.Action("Index", "Maintenance")" class="btn btn-primary">
        <i class="bx bx-plus me-1"></i> Buat Baru
      </a>
      <a href="@Url.Action("Calendar", "Maintenance")" class="btn btn-outline-secondary ms-2">
        <i class="bx bx-calendar me-1"></i> Tampilan Kalender
      </a>
    </div>
  </div>

  <!-- Table Container - Will be updated by AJAX -->
  <div id="tableContainer">
    <!-- Initial content loaded from server -->
    @await Html.PartialAsync("_MaintenanceHistoryTable", Model)
  </div>
</div>

@section PageScripts {
  <!-- DataTables resources for export functionality -->
  <script src="~/vendor/libs/datatables/js/jquery.dataTables.min.js"></script>
  <script src="~/vendor/libs/datatables/js/dataTables.buttons.min.js"></script>
  <script src="~/vendor/libs/datatables/js/jszip.min.js"></script>
  <script src="~/vendor/libs/datatables/js/pdfmake.min.js"></script>
  <script src="~/vendor/libs/datatables/js/vfs_fonts.js"></script>
  <script src="~/vendor/libs/datatables/js/buttons.html5.min.js"></script>

  <!-- Main page JavaScript -->
  <script src="~/js/maintenance-history.js"></script>

  <!-- Inline initialization script -->
  <script>
    $(document).ready(function () {
      MaintenanceHistory.init({
        tableContainerId: 'tableContainer',
        formId: 'filterForm',
        filterInputSelector: 'select, input[type="date"], #GlobalSearch',
        exportContainerId: 'exportButtons',
        pageNumberId: 'PageNumber',
        pageSizeId: 'PageSize',
        resetBtnId: 'resetFilterBtn',
        getTableUrl: '@Url.Action("GetTableData", "MaintenanceHistory")',
        exportTitle: '@(ViewBag.CraneName != null ? $"Riwayat Pemeliharaan - Crane {ViewBag.CraneName}" : "Riwayat Pemeliharaan")'
      });
    });
  </script>
}

<!-- Custom style for no-JS fallback -->
<style noscript>
  .js-only {
    display: none;
  }
</style>
