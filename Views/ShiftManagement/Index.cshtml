@model AspnetCoreMvcFull.ViewModels.ShiftManagement.ShiftListViewModel
@using Newtonsoft.Json
@{
  ViewData["Title"] = "Shift Management";
  Layout = "_ContentNavbarLayout";

  // Ekstrak data shift untuk JavaScript dalam format yang aman
  var jsShiftData = new List<object>();
  foreach (var shift in Model.Shifts)
  {
    if (shift.IsActive)
    {
      jsShiftData.Add(new
      {
        id = shift.Id,
        name = shift.Name,
        startHour = shift.StartTime.Hours,
        startMinute = shift.StartTime.Minutes,
        endHour = shift.EndTime.Hours,
        endMinute = shift.EndTime.Minutes
      });
    }
  }

  // Konversi ke JSON untuk digunakan di JavaScript
  var shiftsJson = JsonConvert.SerializeObject(jsShiftData);
}

@section PageStyles {
  <link rel="stylesheet" href="~/vendor/libs/toastify/toastify.min.css">
  <style>
    #alertContainer {
      display: none;
    }

    .action-buttons .btn {
      margin-right: 0.25rem;
      width: 38px;
      height: 38px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .action-buttons .btn:last-child {
      margin-right: 0;
    }

    .action-buttons .btn i {
      font-size: 1.25rem;
    }

    /* Shift timeline custom styles */
    .vis-item {
      border-width: 1px;
      border-radius: 4px;
      font-size: 12px;
      padding: 2px 8px;
    }

    /* Shift color classes */
    .shift-1 {
      background-color: #4CAF50 !important;
      /* Green */
      border-color: #388E3C !important;
      color: white !important;
    }

    .shift-2 {
      background-color: #2196F3 !important;
      /* Blue */
      border-color: #1976D2 !important;
      color: white !important;
    }

    .shift-3 {
      background-color: #9C27B0 !important;
      /* Purple */
      border-color: #7B1FA2 !important;
      color: white !important;
    }

    .shift-4 {
      background-color: #FF9800 !important;
      /* Orange */
      border-color: #F57C00 !important;
      color: white !important;
    }

    .shift-5 {
      background-color: #F44336 !important;
      /* Red */
      border-color: #D32F2F !important;
      color: white !important;
    }

    /* Timeline customization */
    .vis-timeline {
      border: none;
    }

    .vis-time-axis .vis-text {
      font-size: 10px;
      color: #666;
    }
  </style>
}

<!-- Timeline Card -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">24-Hour Shift Timeline</h5>
  </div>
  <div class="card-body">
    <div id="shift-timeline" style="height: 120px;"></div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Shift Management</h5>
    <a href="@Url.Action("Create")" class="btn btn-primary">
      <i class="bx bx-plus me-1"></i> Add New Shift
    </a>
  </div>

  <div class="table-responsive text-nowrap">
    <table id="shiftsTable" class="table table-hover">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody class="table-border-bottom-0">
        @{
          int rowNumber = 1;
        }
        @foreach (var shift in Model.Shifts)
        {
          <tr style="cursor: pointer;"
            onclick="window.location='@Url.Action("Details", "ShiftManagement", new { id = shift.Id })'">
            <td><strong>@(rowNumber++)</strong></td>
            <td><strong>@shift.Name</strong></td>
            <td>@shift.FormattedStartTime WITA</td>
            <td>@shift.FormattedEndTime WITA</td>
            <td>
              @{
                // Calculate duration considering overnight shifts
                double hours;
                if (shift.EndTime > shift.StartTime)
                {
                  // Normal shift within the same day
                  hours = (shift.EndTime - shift.StartTime).TotalHours;
                }
                else
                {
                  // Overnight shift (add 24 hours to end time)
                  hours = (shift.EndTime.Add(TimeSpan.FromHours(24)) - shift.StartTime).TotalHours;
                }
                @($"{hours:F1} hrs")
              }
            </td>
            <td>
              @if (shift.IsActive)
              {
                <span class="badge bg-success">Active</span>
              }
              else
              {
                <span class="badge bg-secondary">Inactive</span>
              }
            </td>
            <td onclick="event.stopPropagation();">
              <div class="action-buttons">
                <button type="button" class="btn btn-sm btn-outline-primary edit-btn"
                  onclick="window.location='@Url.Action("Edit", "ShiftManagement", new { id = shift.Id })'"
                  data-id="@shift.Id" title="Edit">
                  <i class="bx bx-edit-alt"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger delete-btn"
                  onclick="window.location='@Url.Action("Delete", "ShiftManagement", new { id = shift.Id })'"
                  data-id="@shift.Id" data-name="@System.Web.HttpUtility.HtmlAttributeEncode(shift.Name)" title="Delete">
                  <i class="bx bx-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        }
        @if (!Model.Shifts.Any())
        {
          <tr>
            <td colspan="7" class="text-center">No shifts found. Click "Add New Shift" to create one.</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</div>

@section PageScripts {
  <script src="~/vendor/libs/jquery/jquery.js"></script>
  <script src="~/vendor/libs/toastify/toastify-js.js"></script>
  <link href="~/vendor/libs/vis/vis.min.css" rel="stylesheet" type="text/css" />
  <script src="~/vendor/libs/vis/vis.min.js"></script>

  <script>
    // Toast Notification via Toastify-JS
    $(document).ready(function () {
      function showToast(title, message, type = 'success') {
        Toastify({
          text: title + ': ' + message,
          duration: 5000,
          close: true,
          gravity: 'top',
          position: 'right',
          stopOnFocus: true,
          style: {
            background: type === 'success' ? '#198754' : '#dc3545',
            borderRadius: '0.5rem',
            color: '#fff',
          },
        }).showToast();
      }

      var successMessage = '@(ViewBag.SuccessMessage ?? "")';
      var errorMessage = '@(ViewBag.ErrorMessage ?? "")';

      if (successMessage) {
        showToast('Success', successMessage, 'success');
      }
      if (errorMessage) {
        showToast('Error', errorMessage, 'error');
      }
    });

    // Panggil hanya sekali - flag untuk mencegah inisialisasi duplikat
    var timelineInitialized = false;

    $(document).ready(function () {
      // Initialize only if not already done
      if (!timelineInitialized) {
        console.log('Initializing timeline for the first time');
        initializeTimeline();
        timelineInitialized = true;
      }
    });

    function initializeTimeline() {
      // Cek container
      const container = document.getElementById('shift-timeline');
      if (!container) {
        console.error('Timeline container not found!');
        return;
      }

      // Cek library Vis.js
      if (typeof vis === 'undefined') {
        console.error('Vis.js library not loaded!');
        container.innerHTML = '<div class="alert alert-danger">Timeline visualization failed: Vis.js library not available</div>';
        return;
      }

      try {
        // Buat array untuk menyimpan data shift
        const shiftData = [];

        // Dapatkan data shift dari JSON yang disiapkan di server
        const shifts = @Html.Raw(shiftsJson);

        if (shifts && shifts.length > 0) {
          // Optimized: Use for loop instead of forEach for better performance
          for (let i = 0; i < shifts.length; i++) {
            const shift = shifts[i];

            const startDate = new Date();
            startDate.setHours(shift.startHour, shift.startMinute, 0, 0);

            const endDate = new Date();
            endDate.setHours(shift.endHour, shift.endMinute, 0, 0);

            // Menangani kasus shift yang melewati tengah malam
            if (shift.endHour < shift.startHour) {
              endDate.setDate(endDate.getDate() + 1);
            }

            shiftData.push({
              id: shift.id,
              content: shift.name,
              start: startDate,
              end: endDate,
              className: 'shift-' + (shift.id % 5 + 1)
            });
          }
        } else {
          // Jika tidak ada shift, berikan pesan
          container.innerHTML = '<div class="alert alert-info">No active shifts found.</div>';
          return;
        }

        // Membuat dataset - lebih efisien dengan instansiasi sekali
        const items = new vis.DataSet(shiftData);

        // Membuat rentang timeline 24 jam
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // Setelah perubahan - DIREKOMENDASIKAN
        const options = {
          start: today,
          end: tomorrow,
          timeAxis: { scale: 'hour', step: 1 },
          format: {
            minorLabels: {
              hour: 'H',
              minute: 'H:mm'
            }
          },
          orientation: 'top',
          stack: false,
          zoomable: false,
          moveable: false,
          showCurrentTime: true,
          height: '100px',
          // Hapus opsi throttleRedraw
          // Hapus atau ganti maxItems
          verticalScroll: false,
          horizontalScroll: false,
          showTooltips: false
        };

        // Membuat timeline
        const timeline = new vis.Timeline(container, items, options);

        // Event listener untuk klik item
        timeline.on('click', function (properties) {
          if (properties.item) {
            const shiftId = properties.item;
            window.location.href = '@Url.Action("Details")/' + shiftId;
          }
        });

      } catch (e) {
        console.error('Error creating timeline:', e);
        container.innerHTML = '<div class="alert alert-danger">Timeline visualization failed: ' + e.message + '</div>';
      }
    }
  </script>
}
