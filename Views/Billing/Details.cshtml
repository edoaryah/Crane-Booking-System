<!-- Views/Billing/Details.cshtml -->
@model AspnetCoreMvcFull.ViewModels.Billing.BillingDetailViewModel
@{
  ViewData["Title"] = "Detail Penagihan";
  Layout = "_ContentNavbarLayout";
}

@if (ViewBag.SuccessMessage != null)
{
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    @ViewBag.SuccessMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}
@if (ViewBag.ErrorMessage != null)
{
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    @ViewBag.ErrorMessage
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
}

<!-- <h1>Detail Penagihan</h1>
<p class="lead">Detail penggunaan crane untuk booking @Model.Booking.BookingNumber</p> -->

<!-- Card Info Booking -->
<div class="card mb-4">
  <div class="card-header">
    <i class="bx bx-info-circle me-1"></i>
    Informasi Booking
  </div>
  <div class="card-body">
    <dl class="row">
        <div class="col-md-6">
            <div class="row mb-2">
                <dt class="col-sm-5">No. Booking:</dt>
                <dd class="col-sm-7 fw-bold">@Model.Booking.BookingNumber</dd>
            </div>
            <div class="row mb-2">
                <dt class="col-sm-5">Requester:</dt>
                <dd class="col-sm-7">@Model.Booking.RequesterName</dd>
            </div>
            <div class="row mb-2">
                <dt class="col-sm-5">Departemen:</dt>
                <dd class="col-sm-7">@Model.Booking.Department</dd>
            </div>
            <div class="row mb-2">
                <dt class="col-sm-5">Crane:</dt>
                <dd class="col-sm-7">@Model.Booking.CraneCode (@Model.Booking.CraneCapacity Ton)</dd>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row mb-2">
                <dt class="col-sm-5">Tanggal Booking:</dt>
                <dd class="col-sm-7">@Model.Booking.BookingStartDate.ToString("d MMM yyyy") - @Model.Booking.BookingEndDate.ToString("d MMM yyyy")</dd>
            </div>
            <div class="row mb-2">
                <dt class="col-sm-5">Tanggal Aktual:</dt>
                <dd class="col-sm-7">
                    @if (Model.Booking.ActualStartDate.HasValue && Model.Booking.ActualEndDate.HasValue)
                    {
                        @Model.Booking.ActualStartDate.Value.ToString("d MMM yyyy") <text> - </text>
                        @Model.Booking.ActualEndDate.Value.ToString("d MMM yyyy")
                    }
                    else
                    {
                        <span class="text-muted">Belum ada</span>
                    }
                </dd>
            </div>
            <div class="row mb-2">
                <dt class="col-sm-5">Status:</dt>
                <dd class="col-sm-7">
                    @if (Model.Booking.IsBilled)
                    {
                        <span class="badge bg-success">Sudah Ditagih</span>
                    }
                    else
                    {
                        <span class="badge bg-warning">Belum Ditagih</span>
                    }
                </dd>
            </div>
            @if (Model.Booking.IsBilled)
            {
                <div class="row mb-2">
                    <dt class="col-sm-5">Ditagih Oleh:</dt>
                    <dd class="col-sm-7">@Model.Booking.BilledBy pada @Model.Booking.BilledDate?.ToString("d MMM yyyy HH:mm")</dd>
                </div>
                @if (!string.IsNullOrEmpty(Model.Booking.BillingNotes))
                {
                    <div class="row mb-2">
                        <dt class="col-sm-5">Catatan:</dt>
                        <dd class="col-sm-7">@Model.Booking.BillingNotes</dd>
                    </div>
                }
            }
        </div>
    </dl>

    <!-- Billing Action Buttons -->
    <div class="mt-3 text-end">
      @if (!Model.Booking.IsBilled)
      {
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#billingModal">
          <i class="bx bx-check-circle me-1"></i> Tandai Sudah Ditagih
        </button>
      }
      else
      {
        <form asp-action="UnmarkAsBilled" asp-route-documentNumber="@Model.Booking.DocumentNumber" method="post"
          class="d-inline"
          onsubmit="return confirm('Apakah Anda yakin ingin membatalkan status penagihan untuk booking ini?');">
          @Html.AntiForgeryToken()
          <button type="submit" class="btn btn-warning">
            <i class="bx bx-undo me-1"></i> Batalkan Status Penagihan
          </button>
        </form>
      }
      <a asp-action="Index" class="btn btn-secondary">
        <i class="bx bx-arrow-back me-1"></i> Kembali
      </a>
    </div>
  </div>
</div>

<!-- Card Summary -->
<div class="card mb-4">
  <div class="card-header">
    <i class="bx bx-pie-chart-alt me-1"></i>
    Ringkasan Penggunaan
  </div>
  <div class="card-body">
    <h6 class="card-title mb-3">Total Jam Penggunaan: <strong>@Model.Calculation.TotalHours.ToString("0.0") jam</strong></h6>
    <div class="progress rounded-pill mb-4" style="height: 18px; overflow: hidden;">
        <div class="progress-bar" role="progressbar" style="width: @Model.Calculation.OperatingPercentage%; background-color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Operating);" title="Operating: @Model.Calculation.OperatingHours.ToString("0.0") jam"></div>
        <div class="progress-bar" role="progressbar" style="width: @Model.Calculation.DelayPercentage%; background-color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Delay);" title="Delay: @Model.Calculation.DelayHours.ToString("0.0") jam"></div>
        <div class="progress-bar" role="progressbar" style="width: @Model.Calculation.StandbyPercentage%; background-color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Standby);" title="Standby: @Model.Calculation.StandbyHours.ToString("0.0") jam"></div>
        <div class="progress-bar" role="progressbar" style="width: @Model.Calculation.ServicePercentage%; background-color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Service);" title="Service: @Model.Calculation.ServiceHours.ToString("0.0") jam"></div>
        <div class="progress-bar" role="progressbar" style="width: @Model.Calculation.BreakdownPercentage%; background-color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Breakdown);" title="Breakdown: @Model.Calculation.BreakdownHours.ToString("0.0") jam"></div>
    </div>

    <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span><i class="bx bxs-circle me-2" style="color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Operating);"></i>Operating</span>
            <div>
                <span class="fw-bold me-3">@Model.Calculation.OperatingHours.ToString("0.0") jam</span>
                <span class="badge bg-label-secondary rounded-pill">@Model.Calculation.OperatingPercentage.ToString("0.0")%</span>
            </div>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span><i class="bx bxs-circle me-2" style="color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Delay);"></i>Delay</span>
            <div>
                <span class="fw-bold me-3">@Model.Calculation.DelayHours.ToString("0.0") jam</span>
                <span class="badge bg-label-secondary rounded-pill">@Model.Calculation.DelayPercentage.ToString("0.0")%</span>
            </div>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span><i class="bx bxs-circle me-2" style="color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Standby);"></i>Standby</span>
            <div>
                <span class="fw-bold me-3">@Model.Calculation.StandbyHours.ToString("0.0") jam</span>
                <span class="badge bg-label-secondary rounded-pill">@Model.Calculation.StandbyPercentage.ToString("0.0")%</span>
            </div>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span><i class="bx bxs-circle me-2" style="color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Service);"></i>Service</span>
            <div>
                <span class="fw-bold me-3">@Model.Calculation.ServiceHours.ToString("0.0") jam</span>
                <span class="badge bg-label-secondary rounded-pill">@Model.Calculation.ServicePercentage.ToString("0.0")%</span>
            </div>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
            <span><i class="bx bxs-circle me-2" style="color: @GetCategoryColor(AspnetCoreMvcFull.Models.UsageCategory.Breakdown);"></i>Breakdown</span>
            <div>
                <span class="fw-bold me-3">@Model.Calculation.BreakdownHours.ToString("0.0") jam</span>
                <span class="badge bg-label-secondary rounded-pill">@Model.Calculation.BreakdownPercentage.ToString("0.0")%</span>
            </div>
        </li>
    </ul>
  </div>
</div>

<!-- Card Detail Entry -->
<div class="card mb-4">
  <div class="card-header">
    <i class="bx bx-list-ul me-1"></i>
    Detail Entri Penggunaan
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover" id="entriesTable">
        <thead class="table-light">
          <tr>
            <th>Tanggal</th>
            <th>Waktu</th>
            <th>Kategori</th>
            <th>Subkategori</th>
            <th>Operator</th>
            <th>Durasi</th>
            <th>Catatan</th>
          </tr>
        </thead>
        <tbody>
          @if (Model.Entries != null && Model.Entries.Any())
          {
            @foreach (var entry in Model.Entries)
            {
              <tr>
                <td>@entry.Date.ToString("dd/MM/yyyy")</td>
                <td>@entry.StartTime.ToString(@"hh\:mm") - @entry.EndTime.ToString(@"hh\:mm")</td>
                <td>
                  <span class="badge" style="background-color: @GetCategoryColor(entry.Category)">
                    @entry.Category
                  </span>
                </td>
                <td>@entry.SubcategoryName</td>
                <td>@entry.OperatorName</td>
                <td>@entry.DurationHours.ToString("0.0") jam</td>
                <td>@entry.Notes</td>
              </tr>
            }
          }
          else
          {
            <tr>
              <td colspan="7" class="text-center">Tidak ada entri penggunaan</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Mark as Billed Modal -->
<div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form asp-action="MarkAsBilled" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="BookingId" value="@Model.Booking.BookingId" />
        <input type="hidden" name="BookingNumber" value="@Model.Booking.BookingNumber" />
        <input type="hidden" name="DocumentNumber" value="@Model.Booking.DocumentNumber" />
        <div class="modal-header">
          <h5 class="modal-title" id="billingModalLabel">Tandai Sebagai Sudah Ditagih</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Apakah Anda yakin ingin menandai booking <strong>@Model.Booking.BookingNumber</strong> sebagai sudah
            ditagih?</p>

          <p><strong>Ringkasan Penggunaan:</strong></p>
          <ul>
            <li>Operating: @Model.Calculation.OperatingHours.ToString("0.0") jam</li>
            <li>Delay: @Model.Calculation.DelayHours.ToString("0.0") jam</li>
            <li>Standby: @Model.Calculation.StandbyHours.ToString("0.0") jam</li>
            <li>Service: @Model.Calculation.ServiceHours.ToString("0.0") jam</li>
            <li>Breakdown: @Model.Calculation.BreakdownHours.ToString("0.0") jam</li>
            <li><strong>Total: @Model.Calculation.TotalHours.ToString("0.0") jam</strong></li>
          </ul>

          <div class="mb-3">
            <label for="BillingNotes" class="form-label">Catatan Penagihan (Opsional)</label>
            <textarea id="BillingNotes" name="BillingNotes" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Tandai Sudah Ditagih</button>
        </div>
      </form>
    </div>
  </div>
</div>

@functions {
  public string GetCategoryColor(UsageCategory category)
  {
    return category switch
    {
      UsageCategory.Operating => "#28a745", // Green
      UsageCategory.Delay => "#ffc107", // Yellow
      UsageCategory.Standby => "#6c757d", // Gray
      UsageCategory.Service => "#17a2b8", // Cyan
      UsageCategory.Breakdown => "#dc3545", // Red
      _ => "#6c757d" // Default Gray
    };
  }
}

@section PageScripts {
  <script>
    $(document).ready(function () {
      $('#entriesTable').DataTable({
        language: {
          url: '/lib/datatables/Indonesian.json'
        },
        order: [[0, 'asc'], [1, 'asc']], // Sort by date, then time
        responsive: true
      });
    });
  </script>
}
