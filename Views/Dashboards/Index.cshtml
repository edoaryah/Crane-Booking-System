@model AspnetCoreMvcFull.ViewModels.Dashboard.DashboardViewModel
@{
  ViewData["Title"] = "Dashboard - Analytics";
  @using AspnetCoreMvcFull.Models
}
@section VendorStyles {
  <link rel="stylesheet" href="~/vendor/libs/apex-charts/apex-charts.css" />
  <style>
    .metric-card {
      transition: all 0.3s;
    }

    .metric-card:hover {
      transform: translateY(-5px);
    }

    .metric-icon {
      flex: 0 0 45px;
      height: 45px;
      width: 45px;
      min-height: 45px;
      min-width: 45px;
      max-height: 45px;
      max-width: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
    }

    .metric-icon i {
      font-size: 1.5rem;
    }

    .availability-icon {
      background-color: rgba(105, 108, 255, 0.16);
      color: #696cff;
    }

    .utilisation-icon {
      background-color: rgba(3, 195, 236, 0.16);
      color: #03c3ec;
    }

    .usage-icon {
      background-color: rgba(255, 171, 0, 0.16);
      color: #ffab00;
    }

    .small-progress {
      height: 6px;
      border-radius: 30px;
    }

    #filterForm .form-select-sm,
    #filterForm .form-control-sm {
      @* height: calc(1.5em + 0.5rem + 2px) !important; *@
      height: 38px !important;
    }

    #filterForm .btn-sm {
      height: auto !important;
    }
  </style>
}
@section VendorScripts {
  <script src="~/vendor/libs/apex-charts/apexcharts.js"></script>
}
@section PageScripts {
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Data crane dari model
      const craneData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.CraneMetrics));

      // Tampilkan di console untuk debugging
      console.log("Crane Data:", craneData);

      // Verifikasi data tidak kosong
      if (!craneData || craneData.length === 0) {
        console.warn("No crane data available");
        document.querySelector(".chart-container").innerHTML = "<p class='text-center text-muted'>Data crane tidak tersedia</p>";
        return;
      }

      // Hitung rata-rata untuk metrik - ambil dari model
      const avgAvailability = @Model.SummaryMetrics.AvailabilityPercentage.ToString("0.0");
      const avgUtilisation = @Model.SummaryMetrics.UtilisationPercentage.ToString("0.0");
      const avgUsage = @Model.SummaryMetrics.UsagePercentage.ToString("0.0");

      // Update nilai metrik pada card
      document.getElementById('avgAvailability').textContent = avgAvailability + '%';
      document.getElementById('avgUtilisation').textContent = avgUtilisation + '%';
      document.getElementById('avgUsage').textContent = avgUsage + '%';

      // Update progress bar
      document.getElementById('availabilityProgress').style.width = avgAvailability + '%';
      document.getElementById('utilisationProgress').style.width = avgUtilisation + '%';
      document.getElementById('usageProgress').style.width = avgUsage + '%';

      // Membuat chart - PERBAIKAN: Gunakan properti yang benar
      const options = {
        series: [{
          name: 'Availability',
          data: craneData.map(crane => crane.AvailabilityPercentage) // Gunakan PascalCase
        }, {
          name: 'Utilisation',
          data: craneData.map(crane => crane.UtilisationPercentage) // Gunakan PascalCase
        }, {
          name: 'Usage',
          data: craneData.map(crane => crane.UsagePercentage) // Gunakan PascalCase
        }],
        chart: {
          type: 'bar',
          height: 350,
          stacked: false,
          toolbar: {
            show: true,
            tools: {
              download: true,
              selection: true,
              zoom: true,
              zoomin: true,
              zoomout: true,
              pan: true,
              reset: true
            }
          }
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: '55%',
            endingShape: 'rounded'
          },
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          show: true,
          width: 2,
          colors: ['transparent']
        },
        xaxis: {
          categories: craneData.map(crane => crane.Code), // Gunakan PascalCase
          title: {
            text: 'Kode Crane'
          }
        },
        yaxis: {
          title: {
            text: 'Persentase (%)'
          },
          max: 100
        },
        fill: {
          opacity: 1
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + "%";
            }
          }
        },
        colors: ['#696cff', '#03c3ec', '#ffab00'],
        legend: {
          position: 'top'
        }
      };

      const chart = new ApexCharts(document.querySelector("#craneMetricsChart"), options);
      chart.render();

      // Filter logic
      const monthFilter = document.getElementById('monthFilter');
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const filterForm = document.getElementById('filterForm');

      // When a month is selected, clear custom dates and submit
      monthFilter.addEventListener('change', function () {
        if (this.value) {
          startDateInput.value = '';
          endDateInput.value = '';
          filterForm.submit();
        }
      });

      // When custom filter is submitted, clear the month selection
      filterForm.addEventListener('submit', function (event) {
        // Check if the submission is for the custom date range
        if (startDateInput.value && endDateInput.value) {
          monthFilter.value = '';
        }
      });
    });
  </script>
}

@* ************** Content ************** *@
<div class="row">
  <div class="col-12 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center flex-column flex-lg-row">
        <h5 class="mb-0 text-nowrap">Performa Crane Dashboard</h5>
        <form asp-action="Index" method="get" id="filterForm" class="d-flex align-items-center gap-3 flex-wrap mt-3 mt-lg-0">
          <!-- Filter by Month -->
          <div class="d-flex align-items-center gap-2">
            @* <label for="monthFilter" class="form-label mb-0">Bulan:</label> *@
            <select name="month" id="monthFilter" class="form-select form-select-sm">
              @{
                var currentMonth = DateTime.Now.Month;
              }
              <option value="">Pilih Bulan</option>
              @for (int i = 1; i <= 12; i++)
              {
                var culture = System.Globalization.CultureInfo.GetCultureInfo("id-ID");
                int? selectedMonth = Model.SelectedMonth;
                if (!selectedMonth.HasValue && Model.StartDate == null && Model.EndDate == null)
                {
                  selectedMonth = currentMonth;
                }
                if (selectedMonth == i)
                {
                  <option value="@i" selected>@culture.DateTimeFormat.GetMonthName(i)</option>
                }
                else
                {
                  <option value="@i">@culture.DateTimeFormat.GetMonthName(i)</option>
                }
              }
            </select>
          </div>

          <!-- Custom Date Filter -->
          <div class="d-flex align-items-center gap-2">
            @* <label class="form-label mb-0">Custom:</label> *@
            <input type="date" name="startDate" id="startDate" class="form-control form-control-sm"
              value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
            <span>-</span>
            <input type="date" name="endDate" id="endDate" class="form-control form-control-sm"
              value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
            <button type="submit" class="btn btn-sm btn-primary">Terapkan</button>
          </div>
        </form>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <!-- Availability Metric Card -->
          <div class="col-md-4 col-12 mb-md-0 mb-4">
            <div class="card shadow-none border metric-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div class="metric-icon availability-icon me-3">
                    <i class="bx bx-check-circle"></i>
                  </div>
                  <div>
                    <h5 class="mb-0">Availability</h5>
                    <small class="text-muted">Kesiapan alat untuk digunakan</small>
                  </div>
                </div>
                <h2 id="avgAvailability" class="mb-2">@Model.SummaryMetrics.AvailabilityPercentage.ToString("0.0")%</h2>
                <div class="progress small-progress mb-1">
                  <div id="availabilityProgress" class="progress-bar bg-primary" role="progressbar"
                    style="width: @Model.SummaryMetrics.AvailabilityPercentage%"
                    aria-valuenow="@Model.SummaryMetrics.AvailabilityPercentage" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                @* <small class="text-muted">Available Time / Calendar Time</small> *@
              </div>
            </div>
          </div>

          <!-- Utilisation Metric Card -->
          <div class="col-md-4 col-12 mb-md-0 mb-4">
            <div class="card shadow-none border metric-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div class="metric-icon utilisation-icon me-3">
                    <i class="bx bx-trending-up"></i>
                  </div>
                  <div>
                    <h5 class="mb-0">Utilisation</h5>
                    <small class="text-muted">Tingkat manfaat dari sisi investasi</small>
                  </div>
                </div>
                <h2 id="avgUtilisation" class="mb-2">@Model.SummaryMetrics.UtilisationPercentage.ToString("0.0")%</h2>
                <div class="progress small-progress mb-1">
                  <div id="utilisationProgress" class="progress-bar bg-info" role="progressbar"
                    style="width: @Model.SummaryMetrics.UtilisationPercentage%"
                    aria-valuenow="@Model.SummaryMetrics.UtilisationPercentage" aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
                @* <small class="text-muted">Operating / Calendar Time</small> *@
              </div>
            </div>
          </div>

          <!-- Usage Metric Card -->
          <div class="col-md-4 col-12">
            <div class="card shadow-none border metric-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  <div class="metric-icon usage-icon me-3">
                    <i class="bx bx-time"></i>
                  </div>
                  <div>
                    <h5 class="mb-0">Usage</h5>
                    <small class="text-muted">Tingkat pemakaian alat pada kondisi siap pakai</small>
                  </div>
                </div>
                <h2 id="avgUsage" class="mb-2">@Model.SummaryMetrics.UsagePercentage.ToString("0.0")%</h2>
                <div class="progress small-progress mb-1">
                  <div id="usageProgress" class="progress-bar bg-warning" role="progressbar"
                    style="width: @Model.SummaryMetrics.UsagePercentage%"
                    aria-valuenow="@Model.SummaryMetrics.UsagePercentage" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                @* <small class="text-muted">Utilized Time / Available Time</small> *@
              </div>
            </div>
          </div>
        </div>

        <!-- Crane Metrics Chart -->
        <div class="mt-4">
          <div class="chart-container">
            <div id="craneMetricsChart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Summary Cards -->
<div class="row">
  <!-- Booking Statistics -->
  <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between">
        <div class="card-title mb-0">
          <h5 class="mb-1 me-2">Statistik Booking</h5>
          <p class="card-subtitle">Total @Model.BookingStatistics.TotalBookings booking</p>
        </div>
        <div class="dropdown">
          <button class="btn text-muted p-0" type="button" id="craneStatistics" data-bs-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            <i class="bx bx-dots-vertical-rounded bx-lg"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end" aria-labelledby="craneStatistics">
            <a class="dropdown-item" href="javascript:void(0);" onclick="location.reload()">Refresh</a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <ul class="p-0 m-0">
          <li class="d-flex mb-4 pb-1">
            <div class="avatar flex-shrink-0 me-3">
              <span class="avatar-initial rounded bg-label-success"><i class='bx bx-check-double'></i></span>
            </div>
            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
              <div class="me-2">
                <h6 class="mb-0">Selesai</h6>
                <small class="text-muted">@Model.BookingStatistics.DoneBookings Booking</small>
              </div>
              <div class="user-progress d-flex align-items-center gap-1">
                <h6 class="mb-0">@Model.BookingStatistics.DonePercentage.ToString("0.0")</h6><span
                  class="text-muted">%</span>
              </div>
            </div>
          </li>
          <li class="d-flex mb-4 pb-1">
            <div class="avatar flex-shrink-0 me-3">
              <span class="avatar-initial rounded bg-label-warning"><i class='bx bx-time-five'></i></span>
            </div>
            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
              <div class="me-2">
                <h6 class="mb-0">Berlangsung</h6>
                <small class="text-muted">@Model.BookingStatistics.OngoingBookings Booking</small>
              </div>
              <div class="user-progress d-flex align-items-center gap-1">
                <h6 class="mb-0">@Model.BookingStatistics.OngoingPercentage.ToString("0.0")</h6><span
                  class="text-muted">%</span>
              </div>
            </div>
          </li>
          <li class="d-flex mb-4 pb-1">
            <div class="avatar flex-shrink-0 me-3">
              <span class="avatar-initial rounded bg-label-danger"><i class='bx bx-x-circle'></i></span>
            </div>
            <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
              <div class="me-2">
                <h6 class="mb-0">Dibatalkan</h6>
                <small class="text-muted">@Model.BookingStatistics.CancelledBookings Booking</small>
              </div>
              <div class="user-progress d-flex align-items-center gap-1">
                <h6 class="mb-0">@Model.BookingStatistics.CancelledPercentage.ToString("0.0")</h6><span
                  class="text-muted">%</span>
              </div>
            </div>
          </li>
        </ul>
        <small class="text-muted">Statistik dihitung berdasarkan tanggal pembuatan booking</small>
      </div>
    </div>
  </div>

  <!-- Latest Bookings -->
  <div class="col-md-6 col-lg-4 order-1 mb-6">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between">
        <h5 class="card-title m-0 me-2">Booking Terbaru</h5>
        <div class="dropdown">
          <button class="btn text-muted p-0" type="button" id="latestBookings" data-bs-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            <i class="bx bx-dots-vertical-rounded bx-lg"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end" aria-labelledby="latestBookings">
            <a class="dropdown-item" href="@Url.Action("Index", "BookingList")">Lihat Semua</a>
            <a class="dropdown-item" href="javascript:void(0);" onclick="location.reload()">Refresh</a>
          </div>
        </div>
      </div>

      <div class="card-body">
        <ul class="p-0 m-0">
          @foreach (var booking in Model.LatestBookings)
          {
            var badgeClass = booking.Status switch
            {
              BookingStatus.PendingApproval => "bg-warning",
              BookingStatus.ManagerApproved => "bg-info",
              BookingStatus.ManagerRejected => "bg-danger",
              BookingStatus.PICApproved => "bg-success",
              BookingStatus.PICRejected => "bg-danger",
              BookingStatus.Cancelled => "bg-secondary",
              BookingStatus.Done => "bg-primary",
              _ => "bg-light"
            };
            <li class="d-flex mb-4">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-primary"><i class='bx bx-calendar-event'></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <h6 class="mb-0"><a
                      href="@Url.Action("Details", "Booking", new { documentNumber = booking.DocumentNumber })"
                      class="text-body">@booking.BookingNumber</a></h6>
                  <small class="text-muted">@booking.Department</small>
                </div>
                <div class="user-progress">
                  <span class="badge @badgeClass">
                      @{ var statusText = booking.Status switch
                        {
                          BookingStatus.PendingApproval => "Pending Approval",
                          BookingStatus.ManagerApproved => "Manager Approved",
                          BookingStatus.ManagerRejected => "Rejected by Manager",
                          BookingStatus.PICApproved => "PIC Approved",
                          BookingStatus.PICRejected => "Rejected by PIC",
                          BookingStatus.Cancelled => "Cancelled",
                          BookingStatus.Done => "Completed",
                          _ => booking.Status.ToString()
                        }; }
                      @statusText
                    </span>
                </div>
              </div>
            </li>
          }
        </ul>
      </div>
    </div>
  </div>

  <!-- Breakdown History -->
  <div class="col-md-6 col-lg-4 order-2 mb-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title m-0 me-2">Riwayat Breakdown</h5>
        <div class="dropdown">
          <button class="btn text-muted p-0" type="button" id="breakdownHistory" data-bs-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            <i class="bx bx-dots-vertical-rounded bx-lg"></i>
          </button>
          <div class="dropdown-menu dropdown-menu-end" aria-labelledby="breakdownHistory">
            <a class="dropdown-item" href="@Url.Action("Index", "BreakdownHistory")">Lihat Semua</a>
            <a class="dropdown-item" href="javascript:void(0);" onclick="location.reload()">Refresh</a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <ul class="p-0 m-0">
          @foreach (var item in Model.BreakdownHistories)
          {
            string reasonsDisplay = item.Reasons.Length > 25 ? item.Reasons.Substring(0, 22) + "..." : item.Reasons;
            <li class="d-flex mb-4">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-danger"><i class='bx bx-wrench'></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <h6 class="mb-0">@item.CraneCode</h6>
                  <small class="text-muted">@reasonsDisplay</small>
                </div>
                <div class="user-progress">
                  <small class="text-muted">@item.DurationText</small>
                </div>
              </div>
            </li>
          }
        </ul>
      </div>
    </div>
  </div>
</div>
